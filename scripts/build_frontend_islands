#!/usr/bin/env bash

set -euo pipefail

source "$(dirname "$0")/utils.sh"

function build_frontend_islands() {
  section_start "frontend-islands-check" "Checking for frontend islands"

  # Check if frontend islands directory exists
  if [ ! -d "ee/frontend_islands/apps/duo_next" ]; then
    echoinfo "No frontend islands found at ee/frontend_islands/apps/duo_next, skipping..."
    section_end "frontend-islands-check"
    return 0
  fi

  # Check if frontend islands's dependencies are installed
  if [ ! -d "ee/frontend_islands/apps/duo_next/node_modules" ]; then
    echoinfo "Frontend islands dependencies not found, installing..."
    yarn_install_script
  fi

  echoinfo "Found frontend islands directory, proceeding with build..."
  section_end "frontend-islands-check"

  # Navigate to the frontend island
  cd ee/frontend_islands/apps/duo_next

  section_start "frontend-islands-build" "Building frontend island"
  retry yarn build:prod
  section_end "frontend-islands-build"

  # Verify the build output
  if [ -f "dist/duo_next.js" ]; then
    local file_size=$(du -h dist/duo_next.js | cut -f1)
    echosuccess "Frontend island built successfully at: $(pwd)/dist/duo_next.js (${file_size})"
  else
    echoerr "Expected build output not found at dist/duo_next.js"
    return 1
  fi

  # Return to project root
  cd ../../..
}

section_start "build-frontend-islands" "Building Frontend Islands"
build_frontend_islands
section_end "build-frontend-islands"
